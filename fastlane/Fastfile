# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:android)

platform :android do
  # desc "Build applicaton staging env."
  # lane :build_app_staging do
  #   re_build_staging
  #   get_firebase_version_android
  #   build_staging
  # end

  # desc "Before build app"
  # lane :re_build_staging do
  #   sh('../script/re_build_staging.sh')
  # end

  lane :build_staging do
    change_firebase_config_staging
    get_firebase_version_android
    latest_release = Actions.lane_context[SharedValues::FIREBASE_APP_DISTRO_LATEST_RELEASE]

    # Change build_version and build build_number
    if latest_release.nil?
      build_version = "1.0.0"
      build_number = 1
    else
      build_version = latest_release[:displayVersion] || "1.0.0"
      build_number = (latest_release[:buildVersion].to_i + 1).to_s
    end

    # Get App name and app suffix
    app_name = ENV["APP_NAME"]
    app_suffix = ENV["APP_SUFFIX"]

    # Build app apk
    flutter_build(
      build: 'apk',
      build_name: build_version,
      build_number: build_number,
      build_args: ["--dart-define=APP_NAME=#{app_name}","--dart-define=APP_SUFFIX=#{app_suffix}"]
    )
    
    # flutter_build(
    #   build: 'ipa',
    #   build_name: build_version,
    #   build_number: build_number,
    # )
    upload_firebase_app_distribution
  end 

  lane :get_firebase_version_android do
    desc "Get latest release firebase app distribution and increase version"
    latest_release = firebase_app_distribution_get_latest_release(
      app: ENV["FIREBASE_APP_ID"],
      firebase_cli_token: ENV["FIREBASE_CLI_TOKEN"],
    )
  end

  lane :upload_firebase_app_distribution do
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"],
      groups: "staging-test",
      release_notes: "Production",
      firebase_cli_token: ENV["FIREBASE_CLI_TOKEN"],
      android_artifact_path: ENV["ANDROID_ARTIFACT_PATH"],
    )
  end

  # lane :get_changelog do
  #   read_changelog(
  #     changelog_path: ENV['CHANGELOG_PATH'],
  #   )
  #   update_changelog(
  #     section_identifier: '[Unreleased]', 
  #     updated_section_identifier: 'Build 321'
  #   )
  # end


  lane :change_firebase_config_staging do
    desc "Change firebase config environment staging"
    sh("cat .env.staging > .env")
    sh("cp #{ENV['GOOGLE_SERVICES_PATH']} #{ENV['GOOGLE_SERVICES_NEW_PATH']}")
    sh("cp #{ENV['INFO_PLIST_PATH']} #{ENV['INFO_PLIST_NEW_PATH']}")
    sh("cp #{ENV['GOOGLE_SERVICE_INFO_PATH']} #{ENV['GOOGLE_SERVICE_INFO_NEW_PATH']}")
  end
end